<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Updated on my Ray Tracer - Ilia thoughts</title><meta name="Description" content=""><meta property="og:url" content="https://iliathoughts.com/posts/raytracer2/">
  <meta property="og:site_name" content="Ilia thoughts">
  <meta property="og:title" content="Updated on my Ray Tracer">
  <meta property="og:description" content="My little ray tracer project has had a few improvements since my last post at the start of the year so I thought it would be good to do a new post on the progress. I have mainly been working on a native version using SDL2 for user input (moving the camera) and presentation. However the web version in my previous post was simply returning a list of RGB values which I would then draw directly to the canvas, and using the left-right buttons for input.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-09-06T14:08:06+11:00">
    <meta property="article:modified_time" content="2020-09-06T14:08:06+11:00">
    <meta property="article:tag" content="Ray Tracer">
    <meta property="article:tag" content="Ray Tracer Challenge">
    <meta property="article:tag" content="Webassembly">
    <meta property="article:tag" content="Emscripten">
    <meta property="article:tag" content="C&#43;&#43;">
<meta name="twitter:card" content="summary"><meta name="twitter:title" content="Updated on my Ray Tracer">
<meta name="twitter:description" content="My little ray tracer project has had a few improvements since my last post at the start of the year so I thought it would be good to do a new post on the progress. I have mainly been working on a native version using SDL2 for user input (moving the camera) and presentation. However the web version in my previous post was simply returning a list of RGB values which I would then draw directly to the canvas, and using the left-right buttons for input.">
<meta name="application-name" content="Ilia thoughts">
<meta name="apple-mobile-web-app-title" content="Ilia thoughts"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://iliathoughts.com/posts/raytracer2/" /><link rel="prev" href="https://iliathoughts.com/posts/raytracer/" /><link rel="next" href="https://iliathoughts.com/posts/rust_particles/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Updated on my Ray Tracer",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/iliathoughts.com\/posts\/raytracer2\/"
        },"genre": "posts","keywords": "ray tracer, ray tracer challenge, webassembly, emscripten, C\u002b\u002b","wordcount":  473 ,
        "url": "https:\/\/iliathoughts.com\/posts\/raytracer2\/","datePublished": "2020-09-06T14:08:06+11:00","dateModified": "2020-09-06T14:08:06+11:00","publisher": {
            "@type": "Organization",
            "name": "Author"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Ilia thoughts">Ilia thoughts</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Ilia thoughts">Ilia thoughts</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Updated on my Ray Tracer</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Author</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-09-06">2020-09-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;473 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;3 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents"></nav></div>
            </div><div class="content" id="content"><p>My little ray tracer project has had a few improvements since my last post at the start of the year so I thought it would be good to do a new post on the progress.
I have mainly been working on a native version using SDL2 for user input (moving the camera) and presentation. However the web version in my previous post was simply returning a list of RGB values which I would then draw directly to the canvas, and using the left-right buttons for input. Then I discovered that Emscripten has a port of SDL2 so I could use the same approach for the web version as for the native one.</p>
<p>I also wanted the web version to be multithreaded. The simplest way to do this would be to use pthreads, however it seems that not all browsers implement the SharedArrayBuffer object required to make this work. So to make my ray tracer work on all modern web browsers, I used web workers (with no shared memory). How it works is that one worker parses and serialises the scene, then returns a scene binary, which is then distributed to the other web workers for rendering. Each worker renders 1/(number of possible CPU threads) rows of the scene. Keep in mine the first time you render something after loading the page, it will be a slower because the browser needs to create the web workers, and download the data for textures and 3D models.</p>
<p>Since my last post I&rsquo;ve implemented texture mapping (see skybox and globe scenes), 3D models and bounding volume heirarchies (see Models scene). After rendering a scene you can click on the canvas, then use your keyobard arrow keys (up,down,left,right) of orbit the scene. I have preloaded a few scenes that you can find in the dropdown list. Also there are the following 3rd models located in /rayTracerModels:</p>
<ul>
<li>Stanford Armadillo (armadillo.obj)</li>
<li>Stanford Dragon (dragon.obj)</li>
<li>Stanford Bunny (bunny.obj)</li>
<li>Porsche 911 (porsche.obj)</li>
<li>Blender&rsquo;s Suzanne (suzanne.obj)</li>
</ul>
<p>You can use the syntax in the Models (hippy) scene to define a 3D model object and add it to your scene. Keep in mind this has a 3 models with tens of thousands of triangles so it will be slower to render than the other scenes. It takes about 30 seconds on my 4 core laptop. Just change the camera resolution in the YAML to something smaller to render it faster.</p>
<p>So try it out below! I have done some but not a huge amount of error handling so just reload the page if anything breaks. I&rsquo;ll continue to work on this to make it better, but wanted to get it out there for people to try for now.</p>
  <!DOCTYPE HTML>
  <html>
  <body>
  <label>Select number of web workers: </label>
<select id="coreSelect">
</select>
<br>
  <textarea rows=15 cols=50 id="sceneTextArea">
  </textarea>
  <br>
      <select id="scenes" onChange="return setScene()">
          <option scene="0" value="Choose a scene">Choose a scene</option>
          <option scene="1" value="/rayTracerScenes/reflectionScene.yaml">Reflections</option>
          <option scene="1" value="/rayTracerScenes/tables.yaml">Table</option>
          <option scene="2" value="/rayTracerScenes/groups.yaml">Groups</option>
          <option scene="3" value="/rayTracerScenes/cylinders.yaml">Cylinders</option>
          <option scene="4" value="/rayTracerScenes/hippy.yaml">Hippy</option>
          <option scene="5" value="/rayTracerScenes/shadowPuppets.yaml">Shadow Puppets</option>
          <option scene="6" value="/rayTracerScenes/coverScene.yaml">Cover Scene</option>
          <option scene="7" value="/rayTracerScenes/christmas.yaml">Christmas</option>
          <option scene="8" value="/rayTracerScenes/globe.yaml">Globe</option>
          <option scene="9" value="/rayTracerScenes/skybox.yaml">Skybox</option>
          <option scene="9" value="/rayTracerScenes/hippyModels.yaml">Models (Hippy)</option>
      </select>
      <button id="gobutton">go!</button>
      <!-- <button id="testButton">test</button> -->
  <br>
  <button id="leftbutton">left</button>
  <button id="rightbutton">right</button>
  <br>
  <canvas id="canvas" tabindex="1"></canvas>
  <script id="jsscript" src="/js/Runner.js"></script>
  <script>
        //   Module['doNotCaptureKeyboard'] = true;
        // Module['keyboardListeningElement'] = document.getElementById('canvas');
      var textarea = document.getElementById("sceneTextArea");
      var select = document.getElementById("coreSelect"); 
      Module["onRuntimeInitialized"] = function () {
          const logicalProcessors = window.navigator.hardwareConcurrency;
            var options = Array.from(new Array(logicalProcessors), (x, i) => i + 1);
            // console.log(options);
            for(var i = 0; i < options.length; i++) {
                var opt = options[i];
                var el = document.createElement("option");
                el.textContent = opt;
                el.value = opt;
                select.appendChild(el);
            }
            if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
            // true for mobile device
            select.selectedIndex = parseInt(logicalProcessors/2) - 1;
            }else{
            // false for not mobile device
            select.selectedIndex = parseInt(logicalProcessors) - 1;
            // document.write("not mobile device");
            }
          Module.canvas = (() => document.getElementById('canvas'))();
          var goButton = document.getElementById("gobutton");
          // var testButton = document.getElementById("testButton");
          goButton.addEventListener(
              "click", function() {
              // Module._mainf(textarea.value);
            //   const textCopy = textarea.value;
            console.log(select.options[select.selectedIndex].value);
              Module.ccall('draw', null, ["string","number"], [textarea.value,select.options[select.selectedIndex].value]);
              // Module._test();
          }
          );
          //   testButton.addEventListener(
          //     "click", function() {
          //     Module._killWorker();
          //     }
          // );
          leftbutton.addEventListener(
              "click", function() {
              Module._moveLeft();
              }
          );
          rightbutton.addEventListener(
              "click", function() {
              Module._moveRight();
              }
          );
          document.getElementById('canvas').addEventListener(
              "click", function() {
                  document.getElementById('canvas').focus();
                //   Module.ccall('getModel', null, ["string"], ["/rayTracerModels/donut.obj"]);
              }
          );
      };
      function setScene(){
          // find the dropdown
          var ddl = document.getElementById("scenes");
          // find the selected option
          var selectedOption = ddl.options[ddl.selectedIndex];
          // find the attribute value
          var sceneValue = selectedOption.getAttribute("value");
          // find the textbox
          var textBox = document.getElementById("sceneTextArea");
          fetch(sceneValue)
          .then(response => response.text())
          .then((data) => {
          textBox.value = data
      })
      }
    //   var c = document.getElementById('canvas');
    //   c.addEventListener('keydown',this.check,false);
    //     function check(e) {
    //         alert(e.keyCode);
    //     }
  </script>
  </body>
  </html>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2020-09-06</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/ray-tracer/">Ray Tracer</a>,&nbsp;<a href="/tags/ray-tracer-challenge/">Ray Tracer Challenge</a>,&nbsp;<a href="/tags/webassembly/">Webassembly</a>,&nbsp;<a href="/tags/emscripten/">Emscripten</a>,&nbsp;<a href="/tags/c&#43;&#43;/">C&#43;&#43;</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/raytracer/" class="prev" rel="prev" title="Ray Tracer"><i class="fas fa-angle-left fa-fw"></i>Ray Tracer</a>
            <a href="/posts/rust_particles/" class="next" rel="next" title="Particle Life in Rust">Particle Life in Rust<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
